<!DOCTYPE html>
<html>
	<head>
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.css" />
<script src="http://code.jquery.com/jquery-1.5.2.min.js"></script>
<script src="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.js"></script>
<script type="text/javascript" src="http://cdn.simplegeo.com/js/1.3/simplegeo.places.jq.min.js"></script>

<script>
	var EMAIL = '';

        function jqToHtml(jqObj) {
           var tmp = $('<div></div>');
           tmp.append(jqObj).page();
           return tmp.get(0);
        }

	$('#get-requests').live('touchstart', function(){
		$.get('/favors/favors',
		   {giver: EMAIL},
		   function(favors) {
			console.log('data: ' + favors.length);
			var content = $('#requests').find(
				'[data-role|="content"]');
			content.empty();

                        var listview = $('<ul></ul>');
                        listview.attr('data-role', 'listview');

			for(var i = 0; i < favors.length; i++) {
		            var f = favors[i].favors;
                            var li = $('<li></li>');
                            li.append('<h3>' + f.description + '</h3>');
			    li.append('<p>Requested by: ' + f.takers + '</p>');
			    listview.append(li);
			}

			content.append(jqToHtml(listview));
			$.mobile.changePage('#requests');
		   }
		);
	});
	</script>
	</head>

	<body>

<div data-role="page" id="signup-page">
        <div data-role="content">
		Connect with Mafia Game:
                <a href="#" id='signup-button' data-role="button">Login with Facebook</a>
        </div>
</div>

<div data-role="page" id="about-me"> 
	<div data-role="header" data-backbtn="false" data-position="inline">
		<h1>My Family</h1>
	</div>

	<div data-role="content">
		<a href="#" id='login-button' data-role="button">Login with Facebook</a>
	</div>

        <div data-role="footer">

        <div data-role="navbar"><ul>
          <li><a href="#home">My Favors</a></li>
          <li><a href="#about-me" class="ui-btn-active ui-state-persist">My Family</a></li>
        </ul></div>

	</div>
</div>

<div data-role="page" id="home">
        <div data-role="header" data-backbtn="false" data-position="inline">
 	  <h1>Your Level: Underboss (50/100)</h1>
        </div>

        <div data-role="content">
		<ul data-role="listview" data-theme="g">
		<li>
                        <a href="#create-favor">
                                <h1>Ask for a Favor</h1>
				<p>Cash in on your respect.</p>
                                <p class='ui-li-count'>0/10</p>                        			</a>
		</li>

		<li>
			<a href="#" id="get-requests">
				<h1>Favors requested by other Godfathers</h1>
				<p>Do a favor to earn respect.</p>
				<p class='ui-li-count'>0/10</p>
			</a>
		</li>

                <li>
                        <a href="#">
                                <h1>The Books</h1>
                                <p>The biography of your legacy.</p>
                                <p class='ui-li-count'>10</p>
                        </a>
                </li>
		</ul>
        </div>

	<div data-role="footer">

        <div data-role="navbar"><ul>
          <li><a href="#home" class="ui-btn-active ui-state-persist">My Favors</a></li>
          <li><a href="#about-me">Friends Of Ours</a></li>
        </ul></div>

	</div>
</div>

<div data-role="page" id="create-favor">
        <div data-role="header" data-backbtn="true" data-position="inline">
		<h1>Ask for a Favor</h1>
	</div>

	<div data-role="content">

	<form method="post" action="/favors/create_favor">
	    <input id='create-favors-taker' type="hidden" name="takers"
		   value='' />
	    <input type="text" id='givers-form' name="givers"
		   value="Email of Godfather to get favor from"  />
	    <input type="text" id='description-form' name="description"
		   value="Description of Favor"  />
	    <input type="search" id='places-form' name="places"
		   value="Place (Optional)" />
		<br/>
	    <input type="submit" data-role="button"
		   data-inline="true" value="Ask" />
	</form>

	</div>

        <div data-role="footer">

        <div data-role="navbar"><ul>
          <li><a href="#home" class="ui-btn-active ui-state-persist">My Favors</a></li>
          <li><a href="#about-me">My Family</a></li>
        </ul></div>
        </div>
</div>

<div data-role="page" id="requests">
        <div data-role="header" data-backbtn="false" data-position="inline">
          <h1>Your Level: Underboss (50/100)</h1>
        </div>

        <div data-role="content">
        </div>

        <div data-role="footer">
     	   <div data-role="navbar"><ul>
       	     <li><a href="#home" class="ui-btn-active ui-state-persist">My Favors</a></li>
             <li><a href="#about-me">Friends Of Ours</a></li>
           </ul></div>
        </div>
</div>


    <div id="fb-root"></div>

    <script>
      window.fbAsyncInit = function() {
        FB.init({appId: '152878194785952', status: true, cookie: true,
                 xfbml: true});

        FB.getLoginStatus(function(response) {
          if (response.session) {
            $.mobile.changePage('#home');
	    $('#login-button,#signup-button').find('.ui-btn-text').text('Disconnect from Facebook');

     	    FB.api('/me', function(response) {
		EMAIL = response.email;
		console.log('email: ' + EMAIL);
		$('#create-favors-taker').val(EMAIL);
	    });
          } else {
	    $('#login-button,#signup-button').find('.ui-btn-text').text('Connect with Facebook');
          }
        });

        $('#login-button,#signup-button').live('touchstart', function() {
	  var button = $(this);
          FB.getLoginStatus(function(response) {
            if (response.session) {
              $.mobile.changePage('#home');
              button.find('.ui-btn-text').text('Disconnect from Facebook');

                // Connected. Disconnect.
                FB.logout(function(response) {
                  // user is now logged out
                  button.find('.ui-btn-text').text('Connect with Facebook');
                });
            } else {
                // Not connected. Connect.
                FB.login(function(response) {
                  if (response.session) {
                    if (response.perms) {
                      $.mobile.changePage('#home');
                      // user is logged in and granted some permissions.
                      // perms is a comma separated list of granted permissions
                      button.find('.ui-btn-text').text('Disconnect from Facebook');
                    } else {
                      button.find('.ui-btn-text').text('Connect with Facebook');
                    }
                  } else {
                    // user is not logged in.
                    button.find('.ui-btn-text').text('Connect with Facebook');
                  }
                }, {perms: 'read_stream,publish_stream,offline_access,' +
                           'user_location,email,publish_checkins,' +
                           'friends_location'}
                );
            }
          });
        });


      };
      (function() {
        var e = document.createElement('script');
        e.type = 'text/javascript';
        e.src = 'http://connect.facebook.net/en_US/all.js';
	// document.location.protocol +
        e.async = true;
        document.getElementById('fb-root').appendChild(e);
      }());

      $('#givers-form,#description-form,#places-form').live('click',
	function() {
	  $(this).val('');
        }
       );
    </script>

</body>

</html>

